const sqlite3 = require('sqlite3').verbose();

const db = new sqlite3.Database('./database.db');

// –û—Ç–∑—ã–≤—ã –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –Ω–∞ —Å–∞–π—Ç–µ 30 –¥–µ–∫–∞–±—Ä—è (—Ç–æ–ª—å–∫–æ —ç—Ç–∏ 3)
const reviews = [
  {
    client_name: '–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ò–≤–∞–Ω–æ–≤',
    company: '–û–û–û "–°—Ç—Ä–æ–π–ú–∞—Å—Ç–µ—Ä"',
    rating: 5,
    text: '–û—Ç–ª–∏—á–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è! –¢–µ—Ö–Ω–∏–∫–∞ –≤ –∏–¥–µ–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã —Å–≤–æ–µ–≥–æ –¥–µ–ª–∞. –†–∞–±–æ—Ç–∞–ª–∏ —Å –Ω–∏–º–∏ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–±—ä–µ–∫—Ç–∞—Ö - –≤—Å–µ–≥–¥–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –≤ —Å—Ä–æ–∫.',
    date: '2024-10-15',
    active: 1
  },
  {
    client_name: '–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞',
    company: '–ß–∞—Å—Ç–Ω–æ–µ –ª–∏—Ü–æ',
    rating: 5,
    text: '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å! –ù—É–∂–Ω–æ –±—ã–ª–æ —Å—Ä–æ—á–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –Ω–∞ –≤—ã—Å–æ—Ç–µ. –ê–≤—Ç–æ–≤—ã—à–∫—É –ø–æ–¥–∞–ª–∏ —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –ø–æ—Å–ª–µ –∑–≤–æ–Ω–∫–∞. –í—Å—ë –ø—Ä–æ—à–ª–æ –æ—Ç–ª–∏—á–Ω–æ!',
    date: '2024-10-20',
    active: 1
  },
  {
    client_name: '–î–º–∏—Ç—Ä–∏–π –°–æ–∫–æ–ª–æ–≤',
    company: '–ó–ê–û "–ì–æ—Ä–°—Ç—Ä–æ–π"',
    rating: 5,
    text: '–°–æ—Ç—Ä—É–¥–Ω–∏—á–∞–µ–º —É–∂–µ 3 –≥–æ–¥–∞. –ù–∞–¥–µ–∂–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è —Å –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É—é!',
    date: '2024-11-01',
    active: 1
  }
];

db.serialize(() => {
  console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤...\n');

  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±–∞–∑–æ–≤—ã–µ –æ—Ç–∑—ã–≤—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å)
  // –ú–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
  // db.run('DELETE FROM reviews', (err) => {
  //   if (err) console.error('–û—à–∏–±–∫–∞:', err);
  // });

  // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –æ—Ç–∑—ã–≤—ã
  const stmt = db.prepare(`
    INSERT OR IGNORE INTO reviews 
    (client_name, company, rating, text, date, active) 
    VALUES (?, ?, ?, ?, ?, ?)
  `);

  let added = 0;
  let skipped = 0;
  
  reviews.forEach((review, index) => {
    stmt.run(
      review.client_name,
      review.company,
      review.rating,
      review.text,
      review.date,
      review.active,
      function(err) {
        if (err) {
          if (err.message.includes('UNIQUE constraint')) {
            skipped++;
            console.log(`‚è≠Ô∏è  ${index + 1}. ${review.client_name} - —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—â–µ–Ω`);
          } else {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞ "${review.client_name}":`, err);
          }
        } else {
          added++;
          console.log(`‚úÖ ${index + 1}. ${review.client_name} - –¥–æ–±–∞–≤–ª–µ–Ω`);
        }
      }
    );
  });

  stmt.finalize(() => {
    console.log(`\n‚úÖ –í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: ${added}`);
    console.log(`‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç): ${skipped}`);
    console.log(`üìä –í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤ –≤ –±–∞–∑–µ: ${added + skipped} –∏–∑ ${reviews.length}`);
    console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –æ—Ç–∑—ã–≤—ã —Å —Å–∞–π—Ç–∞ –æ—Ç 30 –¥–µ–∫–∞–±—Ä—è (3 –æ—Ç–∑—ã–≤–∞)\n');
    
    db.close((err) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –±–∞–∑—ã:', err);
      } else {
        console.log('üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        console.log('\nüîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: pm2 restart arenda-neba');
      }
    });
  });
});

